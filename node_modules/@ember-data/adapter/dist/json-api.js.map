{"version":3,"file":"json-api.js","sources":["../src/json-api.ts"],"sourcesContent":["/**\n  @module @ember-data/adapter/json-api\n */\nimport type { AdapterPayload } from '@ember-data/legacy-compat';\nimport type { Snapshot, SnapshotRecordArray } from '@ember-data/legacy-compat/-private';\nimport { dasherize, pluralize } from '@ember-data/request-utils/string';\nimport type Store from '@ember-data/store';\nimport type { ModelSchema } from '@ember-data/store/types';\nimport { assert } from '@warp-drive/build-config/macros';\nimport type { HTTPMethod } from '@warp-drive/core-types/request';\n\nimport { serializeIntoHash } from './-private';\nimport type { FetchRequestInit, JQueryRequestInit, QueryState } from './rest';\nimport RESTAdapter from './rest';\n\n/**\n  ## Overview\n\n  <blockquote style=\"margin: 1em; padding: .1em 1em .1em 1em; border-left: solid 1em #E34C32; background: #e0e0e0;\">\n  <p>\n    ⚠️ <strong>This is LEGACY documentation</strong> for a feature that is no longer encouraged to be used.\n    If starting a new app or thinking of implementing a new adapter, consider writing a\n    <a href=\"/ember-data/release/classes/%3CInterface%3E%20Handler\">Handler</a> instead to be used with the <a href=\"https://github.com/emberjs/data/tree/main/packages/request#readme\">RequestManager</a>\n  </p>\n  </blockquote>\n\n  The `JSONAPIAdapter` is an adapter whichtransforms the store's\n  requests into HTTP requests that follow the [JSON API format](http://jsonapi.org/format/).\n\n  ## JSON API Conventions\n\n  The JSONAPIAdapter uses JSON API conventions for building the URL\n  for a record and selecting the HTTP verb to use with a request. The\n  actions you can take on a record map onto the following URLs in the\n  JSON API adapter:\n\n<table>\n  <tr>\n    <th>\n      Action\n    </th>\n    <th>\n      HTTP Verb\n    </th>\n    <th>\n      URL\n    </th>\n  </tr>\n  <tr>\n    <th>\n      `store.findRecord('post', 123)`\n    </th>\n    <td>\n      GET\n    </td>\n    <td>\n      /posts/123\n    </td>\n  </tr>\n  <tr>\n    <th>\n      `store.findAll('post')`\n    </th>\n    <td>\n      GET\n    </td>\n    <td>\n      /posts\n    </td>\n  </tr>\n  <tr>\n    <th>\n      Update `postRecord.save()`\n    </th>\n    <td>\n      PATCH\n    </td>\n    <td>\n      /posts/123\n    </td>\n  </tr>\n  <tr>\n    <th>\n      Create `store.createRecord('post').save()`\n    </th>\n    <td>\n      POST\n    </td>\n    <td>\n      /posts\n    </td>\n  </tr>\n  <tr>\n    <th>\n      Delete `postRecord.destroyRecord()`\n    </th>\n    <td>\n      DELETE\n    </td>\n    <td>\n      /posts/123\n    </td>\n  </tr>\n</table>\n\n  ## Success and failure\n\n  The JSONAPIAdapter will consider a success any response with a\n  status code of the 2xx family (\"Success\"), as well as 304 (\"Not\n  Modified\"). Any other status code will be considered a failure.\n\n  On success, the request promise will be resolved with the full\n  response payload.\n\n  Failed responses with status code 422 (\"Unprocessable Entity\") will\n  be considered \"invalid\". The response will be discarded, except for\n  the `errors` key. The request promise will be rejected with a\n  `InvalidError`. This error object will encapsulate the saved\n  `errors` value.\n\n  Any other status codes will be treated as an adapter error. The\n  request promise will be rejected, similarly to the invalid case,\n  but with an instance of `AdapterError` instead.\n\n  ### Endpoint path customization\n\n  Endpoint paths can be prefixed with a `namespace` by setting the\n  namespace property on the adapter:\n\n  ```app/adapters/application.js\n  import JSONAPIAdapter from '@ember-data/adapter/json-api';\n\n  export default class ApplicationAdapter extends JSONAPIAdapter {\n    namespace = 'api/1';\n  }\n  ```\n  Requests for the `person` model would now target `/api/1/people/1`.\n\n  ### Host customization\n\n  An adapter can target other hosts by setting the `host` property.\n\n  ```app/adapters/application.js\n  import JSONAPIAdapter from '@ember-data/adapter/json-api';\n\n  export default class ApplicationAdapter extends JSONAPIAdapter {\n    host = 'https://api.example.com';\n  }\n  ```\n\n  Requests for the `person` model would now target\n  `https://api.example.com/people/1`.\n\n  @since 1.13.0\n  @class JSONAPIAdapter\n  @main @ember-data/adapter/json-api\n  @public\n  @constructor\n  @extends RESTAdapter\n*/\nclass JSONAPIAdapter extends RESTAdapter {\n  _defaultContentType = 'application/vnd.api+json';\n\n  /**\n    @method ajaxOptions\n    @private\n    @param {String} url\n    @param {String} type The request type GET, POST, PUT, DELETE etc.\n    @param {Object} options\n    @return {Object}\n  */\n  ajaxOptions(\n    url: string,\n    type: HTTPMethod,\n    options: JQueryAjaxSettings | RequestInit = {}\n  ): JQueryRequestInit | FetchRequestInit {\n    const hash = super.ajaxOptions(url, type, options) as FetchRequestInit;\n    const headers: HeadersInit = (hash.headers = hash.headers || {});\n    headers['Accept'] = (headers['Accept'] as string) || 'application/vnd.api+json';\n\n    return hash;\n  }\n\n  /**\n    By default the JSONAPIAdapter will send each find request coming from a `store.find`\n    or from accessing a relationship separately to the server. If your server supports passing\n    ids as a query string, you can set coalesceFindRequests to true to coalesce all find requests\n    within a single runloop.\n\n    For example, if you have an initial payload of:\n\n    ```javascript\n    {\n      data: {\n        id: 1,\n        type: 'post',\n        relationship: {\n          comments: {\n            data: [\n              { id: 1, type: 'comment' },\n              { id: 2, type: 'comment' }\n            ]\n          }\n        }\n      }\n    }\n    ```\n\n    By default calling `post.comments` will trigger the following requests(assuming the\n    comments haven't been loaded before):\n\n    ```\n    GET /comments/1\n    GET /comments/2\n    ```\n\n    If you set coalesceFindRequests to `true` it will instead trigger the following request:\n\n    ```\n    GET /comments?filter[id]=1,2\n    ```\n\n    Setting coalesceFindRequests to `true` also works for `store.find` requests and `belongsTo`\n    relationships accessed within the same runloop. If you set `coalesceFindRequests: true`\n\n    ```javascript\n    store.findRecord('comment', 1);\n    store.findRecord('comment', 2);\n    ```\n\n    will also send a request to: `GET /comments?filter[id]=1,2`\n\n    Note: Requests coalescing rely on URL building strategy. So if you override `buildURL` in your app\n    `groupRecordsForFindMany` more likely should be overridden as well in order for coalescing to work.\n\n    @property coalesceFindRequests\n    @public\n    @type {boolean}\n  */\n  get coalesceFindRequests() {\n    const coalesceFindRequests = this._coalesceFindRequests;\n    if (typeof coalesceFindRequests === 'boolean') {\n      return coalesceFindRequests;\n    }\n    return (this._coalesceFindRequests = false);\n  }\n\n  set coalesceFindRequests(value: boolean) {\n    this._coalesceFindRequests = value;\n  }\n\n  findMany(store: Store, type: ModelSchema, ids: string[], snapshots: Snapshot[]): Promise<AdapterPayload> {\n    const url = this.buildURL(type.modelName, ids, snapshots, 'findMany');\n    return this.ajax(url, 'GET', { data: { filter: { id: ids.join(',') } } });\n  }\n\n  pathForType(modelName: string): string {\n    const dasherized = dasherize(modelName);\n    return pluralize(dasherized);\n  }\n\n  updateRecord(store: Store, schema: ModelSchema, snapshot: Snapshot): Promise<AdapterPayload> {\n    const data = serializeIntoHash(store, schema, snapshot);\n    const type = snapshot.modelName;\n    const id = snapshot.id;\n    assert(`Attempted to update the ${type} record, but the record has no id`, typeof id === 'string' && id.length > 0);\n\n    const url = this.buildURL(type, id, snapshot, 'updateRecord');\n\n    return this.ajax(url, 'PATCH', { data: data });\n  }\n\n  /**\n    Used by `findAll` and `findRecord` to build the query's `data` hash\n    supplied to the ajax method.\n\n    @method buildQuery\n    @since 2.5.0\n    @public\n    @param  {Snapshot} snapshot\n    @return {Object}\n  */\n  buildQuery(snapshot: Snapshot | SnapshotRecordArray): QueryState {\n    const query: QueryState = {};\n\n    if (snapshot) {\n      const { include } = snapshot;\n      const normalizedInclude = Array.isArray(include) ? include.join(',') : include;\n\n      if (normalizedInclude) {\n        query.include = normalizedInclude;\n      }\n    }\n\n    return query;\n  }\n}\n\nexport default JSONAPIAdapter;\n"],"names":["JSONAPIAdapter","RESTAdapter","_defaultContentType","ajaxOptions","url","type","options","hash","headers","coalesceFindRequests","_coalesceFindRequests","value","findMany","store","ids","snapshots","buildURL","modelName","ajax","data","filter","id","join","pathForType","dasherized","dasherize","pluralize","updateRecord","schema","snapshot","serializeIntoHash","macroCondition","getGlobalConfig","WarpDrive","env","DEBUG","test","Error","length","buildQuery","query","include","normalizedInclude","Array","isArray"],"mappings":"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"}