{"version":3,"file":"babel-plugin-transform-deprecations.cjs","sources":["../cjs-src/transforms/babel-plugin-transform-deprecations.js"],"sourcesContent":["import { ImportUtil } from 'babel-import-util';\n\nfunction parentIsUnary(node) {\n  if (node.parent.type === 'UnaryExpression' && node.parent.operator === '!') {\n    return true;\n  }\n  return false;\n}\n\nexport default function (babel) {\n  const { types: t } = babel;\n\n  return {\n    name: 'deprecation-flags',\n    visitor: {\n      ImportDeclaration(path, state) {\n        const importPath = path.node.source.value;\n\n        if (importPath === state.opts.source) {\n          const specifiers = path.get('specifiers');\n          specifiers.forEach((specifier) => {\n            let name = specifier.node.imported.name;\n            if (!(name in state.opts.flags)) {\n              throw new Error(`Unexpected flag ${name} imported from ${state.opts.source}`);\n            }\n            let localBindingName = specifier.node.local.name;\n            let binding = specifier.scope.getBinding(localBindingName);\n            binding.referencePaths.forEach((p, other) => {\n              let negateStatement = false;\n              let node = p;\n              if (parentIsUnary(p)) {\n                negateStatement = true;\n                node = p.parentPath;\n              }\n              const comments =\n                node.node.leadingComments ??\n                (node.parent.type === 'ConditionalExpression' && node.parent.leadingComments) ??\n                [];\n              let shouldInlineConfigValue = false;\n              if (comments?.length) {\n                const lastComment = comments.at(-1);\n                if (lastComment.value.trim() === 'inline-macro-config') {\n                  shouldInlineConfigValue = true;\n                }\n              }\n\n              let getConfig = t.memberExpression(\n                t.memberExpression(\n                  t.memberExpression(\n                    t.callExpression(state.importer.import(p, '@embroider/macros', 'getGlobalConfig'), []),\n                    t.identifier('WarpDrive')\n                  ),\n                  t.identifier('deprecations')\n                ),\n                t.identifier(name)\n              );\n\n              const configExp = negateStatement ? t.unaryExpression('!', getConfig) : getConfig;\n              const replaceExp = shouldInlineConfigValue\n                ? // if (DEPRECATE_FOO)\n                  // =>\n                  // if (getGlobalConfig('WarpDrive').deprecations.FOO)\n                  configExp\n                : // if (DEPRECATE_FOO)\n                  // =>\n                  // if (macroCondition(getGlobalConfig('WarpDrive').deprecations.FOO))\n                  t.callExpression(state.importer.import(p, '@embroider/macros', 'macroCondition'), [configExp]);\n              node.replaceWith(replaceExp);\n            });\n            specifier.scope.removeOwnBinding(localBindingName);\n            specifier.remove();\n          });\n          if (path.get('specifiers').length === 0) {\n            path.remove();\n          }\n        }\n      },\n\n      Program(path, state) {\n        state.importer = new ImportUtil(t, path);\n      },\n    },\n  };\n}\n"],"names":["parentIsUnary","node","parent","type","operator","babel","types","t","name","visitor","ImportDeclaration","path","state","importPath","source","value","opts","specifiers","get","forEach","specifier","imported","flags","Error","localBindingName","local","binding","scope","getBinding","referencePaths","p","other","negateStatement","parentPath","comments","leadingComments","shouldInlineConfigValue","length","lastComment","at","trim","getConfig","memberExpression","callExpression","importer","import","identifier","configExp","unaryExpression","replaceExp","replaceWith","removeOwnBinding","remove","Program","ImportUtil"],"mappings":"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"}