{"version":3,"file":"auto-import.js","sourceRoot":"","sources":["../ts/auto-import.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,0DAAkC;AAClC,uCAAkD;AAClD,0DAAkC;AAElC,wDAAqD;AACrD,oEAA2C;AAC3C,oEAA2C;AAE3C,qCAAyC;AACzC,kEAOqC;AACrC,wDAAuC;AACvC,2DAA6C;AAC7C,qDAA6C;AAC7C,yCAAsC;AACtC,gFAA8C;AAC9C,sDAA8B;AAE9B,gFAAsD;AACtD,oDAA4B;AAE5B,uDAA2C;AAC3C,gDAAwB;AACxB,sEAAqC;AACrC,kDAA8B;AAE9B,MAAM,SAAS,GAAG,wBAAa,CAAC,kBAAkB,CAAC,mBAAmB,CAAC,CAAC;AACxE,MAAM,UAAU,GAAG,IAAA,eAAS,EAAC,yBAAyB,CAAC,CAAC;AA6BxD,MAAqB,UAAU;IAc7B,MAAM,CAAC,QAAQ,CAAC,KAAoB;QAClC,sBAAa,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC;IACxE,CAAC;IAED,MAAM,CAAC,MAAM,CAAC,KAAoB;QAChC,OAAO,sBAAa,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC;IACzC,CAAC;IAED,YAAY,aAA4B;QArBhC,aAAQ,GAAiB,IAAI,GAAG,EAAE,CAAC;QAInC,cAAS,GAA2B,IAAI,GAAG,EAAE,CAAC;QAGtD,kCAAkC;QAC1B,aAAQ,GAAG,IAAI,GAAG,EAGvB,CAAC;QAWF,IAAI,YAAY,GAAG,IAAA,mCAAgB,EAAC,aAAa,CAAC,CAAC;QACnD,IAAI,CAAC,YAAY,GAAG,+BAAY,CAAC,MAAM,CACrC,mBAAmB,EACnB,YAAY,CAAC,OAAO,CAAC,IAAI,CAC1B,CAAC;QACF,IAAI,CAAC,QAAQ,CAAC,GAAG,CACf,iBAAO,CAAC,cAAc,CAAC,YAAY,EAAE,IAAI,CAAC,eAAe,CAAC,CAC3D,CAAC;QACF,IAAI,IAAI,GAAG,YAAY,CAAC,GAAG,CAAC;QAE5B,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;QAE5B,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QACpB,IAAI,CAAC,OAAO,GAAG,IAAI,uBAAY,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC1D,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;YACd,MAAM,IAAI,KAAK,CAAC,wDAAwD,CAAC,CAAC;QAC5E,CAAC;QAED,IAAI,CAAC,YAAY,GAAG,CAAC,GAAG,IAAI,EAAE,EAAE,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,CAAC;IAC3E,CAAC;IAED,gBAAgB,CAAC,KAAkB;QACjC,gEAAgE;QAChE,IAAI,IAAI,GAIJ,KAAY,CAAC;QACjB,IAAI,IAAI,CAAC,WAAW,CAAC,eAAe,CAAC,MAAM,EAAE,CAAC;YAC5C,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,IAAA,yBAAM,EAAC,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE;gBACtC,OAAO,EAAE,IAAI,CAAC,WAAW,CAAC,eAAe;aAC1C,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAED,yEAAyE;IACzE,4EAA4E;IAC5E,SAAS;IACT,SAAS,CAAC,MAAqB;QAC7B,OAAO,KAAK,CAAC;IACf,CAAC;IAED,OAAO,CACL,IAAU,EACV,KAAoB,EACpB,QAAmB,EACnB,oBAA2B;QAE3B,IAAI,IAAI,GAAG,iBAAO,CAAC,cAAc,CAAC,KAAK,EAAE,IAAI,CAAC,eAAe,CAAC,CAAC;QAC/D,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QACxB,IAAI,QAAQ,GAAG,IAAI,kBAAQ,CACzB,SAAS,CAAC,IAAI,EAAE,sBAAsB,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,EAC5D,IAAI,EACJ,QAAQ,EACR,oBAAoB,CACrB,CAAC;QACF,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACnC,OAAO,QAAQ,CAAC;IAClB,CAAC;IAED,eAAe,CACb,WAAmB,EACnB,WAAmB,EACnB,UAAyB,EAAE;QAE3B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,WAAW,EAAE,EAAE,IAAI,EAAE,WAAW,EAAE,OAAO,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,IAAI,eAAe;QACjB,OAAO;YACL,UAAU,EAAE,CAAC,IAAY,EAAW,EAAE;gBACpC,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACjC,CAAC;YAED,WAAW,EAAE,CAAC,IAAY,EAAsB,EAAE;;gBAChD,OAAO,MAAA,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,0CAAE,IAAI,CAAC;YACvC,CAAC;YAED,cAAc,EAAE,CAAC,IAAY,EAAU,EAAE;gBACvC,IAAI,GAAG,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAC1C,IAAI,GAAG,EAAE,CAAC;oBACR,OAAO,GAAG,CAAC;gBACb,CAAC;gBACD,GAAG,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,IAAI,GAAG,KAAK,CAAC,CAAC;gBAC9C,IAAI,GAAG,EAAE,CAAC;oBACR,OAAO,GAAG,CAAC;gBACb,CAAC;gBACD,GAAG,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,IAAI,GAAG,WAAW,CAAC,CAAC;gBACpD,IAAI,GAAG,EAAE,CAAC;oBACR,OAAO,GAAG,CAAC;gBACb,CAAC;gBACD,OAAO,IAAI,CAAC;YACd,CAAC;SACF,CAAC;IACJ,CAAC;IAIO,cAAc;QACpB,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;YAC1B,IAAI,CAAC,eAAe,GAAG,IAAI,GAAG,EAAE,CAAC;YACjC,KAAK,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,EAAE,CAAC;gBACrD,IAAI,GAAG,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBACtC,IAAI,GAAG,CAAC,SAAS,EAAE,EAAE,CAAC;oBACpB,IAAI,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC;oBACpB,IAAI,OAAO,CAAC,aAAa,EAAE,CAAC;wBAC1B,kEAAkE;wBAClE,4BAA4B;wBAC5B,IAAI,GAAG,OAAO,CAAC,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBACjE,CAAC;oBACD,IAAI,cAAc,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC;oBAC7C,IAAI,cAAc,EAAE,CAAC;wBACnB,KAAK,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE,CAAC;4BACtD,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;wBACrC,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC,eAAe,CAAC;IAC9B,CAAC;IAEO,WAAW,CAAC,UAAgB;QAClC,8DAA8D;QAC9D,iDAAiD;QACjD,IAAI,QAAQ,GAAG,IAAI,kBAAQ,CAAC;YAC1B,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,OAAO,EAAE,IAAI,CAAC,OAAO;SACtB,CAAC,CAAC;QAEH,IAAI,OAA2B,CAAC;QAChC,MAAM,GAAG,GAAG,IAAA,8BAAkB,EAAC,SAAS,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEjE,8DAA8D;QAC9D,IAAI,GAAG,IAAI,gBAAM,CAAC,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,CAAC;YAC5D,8DAA8D;YAC9D,OAAO,GAAG,OAAO,CAAC,iBAAO,CAAC,IAAI,CAAC,SAAS,EAAE;gBACxC,OAAO,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI;aAC/B,CAAC,CAAuB,CAAC;QAC5B,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,KAAK,CACb,0GAA0G,CAC3G,CAAC;QACJ,CAAC;QAED,+DAA+D;QAC/D,8CAA8C;QAC9C,OAAO,IAAI,iBAAc,CAAC,OAAO,CAAC,UAAU,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE;YAC5D,QAAQ;YACR,WAAW,EAAE,IAAI,CAAC,GAAG;YACrB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,OAAO,EAAE,IAAI,CAAC,OAAO;YACrB,OAAO;YACP,WAAW,EAAE,IAAI,CAAC,WAAW;SAC9B,CAAC,CAAC;IACL,CAAC;IAGD,IAAY,WAAW;QACrB,IAAI,WAAW,GAAG,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QAC1E,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,MAAM,IAAI,KAAK,CACb,iFAAiF,CAClF,CAAC;QACJ,CAAC;QACD,OAAO,WAAW,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,UAAgB;QACpB,IAAI,OAAO,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,EAAE,QAAQ,CAAC,CAAC;QACnE,IAAI,QAAQ,GAAG,IAAI,mBAAQ,CAAC,UAAU,EAAE,OAAO,EAAE,IAAI,CAAC,OAAO,EAAE;YAC7D,cAAc,EAAE,IAAI,CAAC,WAAW,CAAC,cAAc,EAAE;YACjD,eAAe,EAAE,IAAI,CAAC,WAAW,CAAC,eAAe;YACjD,cAAc,EAAE,IAAI,CAAC,WAAW,CAAC,cAAc;SAChD,CAAC,CAAC;QACH,IAAI,KAAK,GAAG,CAAC,UAAU,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAC;QAC5C,OAAO,IAAA,8BAAU,EAAC,KAAK,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAChD,CAAC;IAED,2EAA2E;IAC3E,4EAA4E;IAC5E,8EAA8E;IAC9E,kBAAkB;IAClB,QAAQ,CAAC,aAA4B;QACnC,IAAI,CAAC,kBAAkB,CAAC,aAAa,CAAC,CAAC;QACvC,IAAI,CAAC,IAAA,sCAAmB,EAAC,aAAa,CAAC,EAAE,CAAC;YACxC,IAAI,CAAC,qBAAqB,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;QAChD,CAAC;IACH,CAAC;IAEO,kBAAkB,CAAC,aAA4B;QACrD,IAAI,MAAmC,CAAC;QACxC,IAAI,IAAA,sCAAmB,EAAC,aAAa,CAAC,EAAE,CAAC;YACvC,MAAM,GAAG,aAAa,CAAC,MAAM,CAAC;QAChC,CAAC;aAAM,CAAC;YACN,MAAM,GAAG,aAAa,CAAC,GAAG,CAAC;QAC7B,CAAC;QAED,IAAI,YAAY,GAAqB,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK;YACxD,MAAM,CAAC,OAAO,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;QAC9B,IAAI,YAAY,GAAG,CAAC,YAAY,CAAC,OAAO,GAAG,YAAY,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC;QACvE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE,CAAC;YACzC,qEAAqE;YACrE,iBAAiB;YACjB,YAAY,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,mBAAmB,CAAC,EAAE,EAAE,MAAM,EAAN,wBAAM,EAAE,CAAC,CAAC,CAAC;QAC3E,CAAC;IACH,CAAC;IAED,wEAAwE;IACxE,0EAA0E;IAC1E,0DAA0D;IAClD,qBAAqB,CAAC,IAAiB;QAC7C,IAAI,QAAQ,GAAG,CAAC,mBAAmB,EAAE,oBAAoB,CAAC,CAAC;QAC3D,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC;YAC9B,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,EAAE,CAAC;QAChC,CAAC;QACD,IAAI,CAAC,CAAC,SAAS,IAAI,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC;YAC7C,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,OAAO,GAAG,QAAQ,CAAC;QAC9C,CAAC;aAAM,CAAC;YACN,KAAK,IAAI,OAAO,IAAI,QAAQ,EAAE,CAAC;gBAC7B,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACjD,CAAC;QACH,CAAC;IACH,CAAC;CACF;AAxPD,6BAwPC;AAlEC;IADC,IAAA,4BAAO,GAAE;6CAST;AA4DH,SAAS,OAAO,CAAC,UAAgB,EAAE,QAAsB;IACvD,IAAI,IAAI,GAAG,CAAC,UAAU,CAAC,CAAC;IACxB,KAAK,IAAI,GAAG,IAAI,QAAQ,EAAE,CAAC;QACzB,IAAI,OAAO,GAAG,GAAG,CAAC,kBAAkB,CAAC;QACrC,IAAI,OAAO,EAAE,CAAC;YACZ,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,4BAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAC9D,UAAU,CAAC,+BAA+B,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QAClE,CAAC;IACH,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAS,gBAAgB,CAAC,KAAc;IACtC,MAAM,MAAM,GAAG,cAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE,IAAI,EAAE,oBAAoB,CAAC,CAAC;IAC1E,OAAO,CACL,CAAC,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACrD,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC;YACnB,OAAO,KAAK,CAAC,CAAC,CAAC,KAAK,QAAQ;YAC5B,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAC7B,CAAC;AACJ,CAAC","sourcesContent":["import Splitter from './splitter';\nimport { Bundler, debugBundler } from './bundler';\nimport Analyzer from './analyzer';\nimport type { TreeType } from './analyzer';\nimport Package, { V2AddonResolver } from './package';\nimport BroccoliDebug from 'broccoli-debug';\nimport BundleConfig from './bundle-config';\nimport type { Node } from 'broccoli-node-api';\nimport { LeaderChooser } from './leader';\nimport {\n  AddonInstance,\n  AddonMeta,\n  AppInstance,\n  findTopmostAddon,\n  isDeepAddonInstance,\n  PackageCache,\n} from '@embroider/shared-internals';\nimport WebpackBundler from './webpack';\nimport { Memoize } from 'typescript-memoize';\nimport { WatchedDir } from 'broccoli-source';\nimport { Inserter } from './inserter';\nimport mergeTrees from 'broccoli-merge-trees';\nimport resolve from 'resolve';\nimport type webpackType from 'webpack';\nimport resolvePackagePath from 'resolve-package-path';\nimport semver from 'semver';\nimport type { TransformOptions } from '@babel/core';\nimport { MARKER } from './analyzer-syntax';\nimport path from 'path';\nimport funnel from 'broccoli-funnel';\nimport makeDebug from 'debug';\n\nconst debugTree = BroccoliDebug.buildDebugCallback('ember-auto-import');\nconst debugWatch = makeDebug('ember-auto-import:watch');\n\n// This interface must be stable across all versions of ember-auto-import that\n// speak the same leader-election protocol. So don't change this unless you know\n// what you're doing.\nexport interface AutoImportSharedAPI {\n  isPrimary(addonInstance: AddonInstance): boolean;\n  analyze(\n    tree: Node,\n    addon: AddonInstance,\n    treeType?: TreeType,\n    supportsFastAnalyzer?: true\n  ): Node;\n  included(addonInstance: AddonInstance): void;\n  addTo(tree: Node): Node;\n  registerV2Addon(\n    packageName: string,\n    packageRoot: string,\n    compatOptions?: CompatOptions\n  ): void;\n}\n\n// This interface must be stable across all versions of ember-auto-import that\n// speak the same leader-election protocol. So don't change this unless you know\n// what you're doing.\nexport interface CompatOptions {\n  customizeMeta?: (meta: AddonMeta) => AddonMeta;\n}\n\nexport default class AutoImport implements AutoImportSharedAPI {\n  private packages: Set<Package> = new Set();\n  private packageCache: PackageCache;\n  private env: 'development' | 'test' | 'production';\n  private consoleWrite: (msg: string) => void;\n  private analyzers: Map<Analyzer, Package> = new Map();\n  private bundles: BundleConfig;\n\n  // maps packageName to packageRoot\n  private v2Addons = new Map<\n    string,\n    { root: string; options: CompatOptions }\n  >();\n\n  static register(addon: AddonInstance) {\n    LeaderChooser.for(addon).register(addon, () => new AutoImport(addon));\n  }\n\n  static lookup(addon: AddonInstance): AutoImportSharedAPI {\n    return LeaderChooser.for(addon).leader;\n  }\n\n  constructor(addonInstance: AddonInstance) {\n    let topmostAddon = findTopmostAddon(addonInstance);\n    this.packageCache = PackageCache.shared(\n      'ember-auto-import',\n      topmostAddon.project.root\n    );\n    this.packages.add(\n      Package.lookupParentOf(topmostAddon, this.v2AddonResolver)\n    );\n    let host = topmostAddon.app;\n\n    this.installAppFilter(host);\n\n    this.env = host.env;\n    this.bundles = new BundleConfig(host.options.outputPaths);\n    if (!this.env) {\n      throw new Error('Bug in ember-auto-import: did not discover environment');\n    }\n\n    this.consoleWrite = (...args) => addonInstance.project.ui.write(...args);\n  }\n\n  installAppFilter(_host: AppInstance) {\n    // TODO upstream this type change to @embroider/shared-internals\n    let host: AppInstance & {\n      trees: {\n        app: Node;\n      };\n    } = _host as any;\n    if (this.rootPackage.allowAppImports.length) {\n      host.trees.app = funnel(host.trees.app, {\n        exclude: this.rootPackage.allowAppImports,\n      });\n    }\n  }\n\n  // we don't actually call this ourselves anymore, but earlier versions of\n  // ember-auto-import will still call it on us. For them the answer is always\n  // false.\n  isPrimary(_addon: AddonInstance) {\n    return false;\n  }\n\n  analyze(\n    tree: Node,\n    addon: AddonInstance,\n    treeType?: TreeType,\n    supportsFastAnalyzer?: true\n  ) {\n    let pack = Package.lookupParentOf(addon, this.v2AddonResolver);\n    this.packages.add(pack);\n    let analyzer = new Analyzer(\n      debugTree(tree, `preprocessor:input-${this.analyzers.size}`),\n      pack,\n      treeType,\n      supportsFastAnalyzer\n    );\n    this.analyzers.set(analyzer, pack);\n    return analyzer;\n  }\n\n  registerV2Addon(\n    packageName: string,\n    packageRoot: string,\n    options: CompatOptions = {}\n  ): void {\n    this.v2Addons.set(packageName, { root: packageRoot, options });\n  }\n\n  get v2AddonResolver(): V2AddonResolver {\n    return {\n      hasV2Addon: (name: string): boolean => {\n        return this.v2Addons.has(name);\n      },\n\n      v2AddonRoot: (name: string): string | undefined => {\n        return this.v2Addons.get(name)?.root;\n      },\n\n      handleRenaming: (name: string): string => {\n        let hit = this.renamedModules().get(name);\n        if (hit) {\n          return hit;\n        }\n        hit = this.renamedModules().get(name + '.js');\n        if (hit) {\n          return hit;\n        }\n        hit = this.renamedModules().get(name + '/index.js');\n        if (hit) {\n          return hit;\n        }\n        return name;\n      },\n    };\n  }\n\n  private _renamedModules: Map<string, string> | undefined;\n\n  private renamedModules(): Map<string, string> {\n    if (!this._renamedModules) {\n      this._renamedModules = new Map();\n      for (let { root, options } of this.v2Addons.values()) {\n        let pkg = this.packageCache.get(root);\n        if (pkg.isV2Addon()) {\n          let meta = pkg.meta;\n          if (options.customizeMeta) {\n            // json here is just a super simple clone so the hook can't mutate\n            // our cache unintentionally\n            meta = options.customizeMeta(JSON.parse(JSON.stringify(meta)));\n          }\n          let renamedModules = meta['renamed-modules'];\n          if (renamedModules) {\n            for (let [from, to] of Object.entries(renamedModules)) {\n              this._renamedModules.set(from, to);\n            }\n          }\n        }\n      }\n    }\n    return this._renamedModules;\n  }\n\n  private makeBundler(allAppTree: Node): Bundler {\n    // The Splitter takes the set of imports from the Analyzer and\n    // decides which ones to include in which bundles\n    let splitter = new Splitter({\n      analyzers: this.analyzers,\n      bundles: this.bundles,\n    });\n\n    let webpack: typeof webpackType;\n    const pkg = resolvePackagePath('webpack', this.rootPackage.root);\n\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    if (pkg && semver.satisfies(require(pkg).version, '^5.0.0')) {\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      webpack = require(resolve.sync('webpack', {\n        basedir: this.rootPackage.root,\n      })) as typeof webpackType;\n    } else {\n      throw new Error(\n        `[ember-auto-import] this version of ember-auto-import requires the app to have a dependency on webpack 5`\n      );\n    }\n\n    // The Bundler asks the splitter for deps it should include and\n    // is responsible for packaging those deps up.\n    return new WebpackBundler(depsFor(allAppTree, this.packages), {\n      splitter,\n      environment: this.env,\n      packages: this.packages,\n      consoleWrite: this.consoleWrite,\n      bundles: this.bundles,\n      webpack,\n      rootPackage: this.rootPackage,\n    });\n  }\n\n  @Memoize()\n  private get rootPackage(): Package {\n    let rootPackage = [...this.packages.values()].find((pkg) => !pkg.isAddon);\n    if (!rootPackage) {\n      throw new Error(\n        `bug in ember-auto-import, there should always be a Package representing the app`\n      );\n    }\n    return rootPackage;\n  }\n\n  addTo(allAppTree: Node): Node {\n    let bundler = debugBundler(this.makeBundler(allAppTree), 'output');\n    let inserter = new Inserter(allAppTree, bundler, this.bundles, {\n      publicAssetURL: this.rootPackage.publicAssetURL(),\n      insertScriptsAt: this.rootPackage.insertScriptsAt,\n      insertStylesAt: this.rootPackage.insertStylesAt,\n    });\n    let trees = [allAppTree, bundler, inserter];\n    return mergeTrees(trees, { overwrite: true });\n  }\n\n  // CAUTION: versions <= 2.1.0 only invoked this method on the app's copy of\n  // ember-auto-import, whereas we now invoke it on every copy. That means you\n  // can't guarantee this will be called for an addon that is using one of those\n  // older versions.\n  included(addonInstance: AddonInstance) {\n    this.installBabelPlugin(addonInstance);\n    if (!isDeepAddonInstance(addonInstance)) {\n      this.configureFingerprints(addonInstance.app);\n    }\n  }\n\n  private installBabelPlugin(addonInstance: AddonInstance): void {\n    let parent: AppInstance | AddonInstance;\n    if (isDeepAddonInstance(addonInstance)) {\n      parent = addonInstance.parent;\n    } else {\n      parent = addonInstance.app;\n    }\n\n    let babelOptions: TransformOptions = (parent.options.babel =\n      parent.options.babel || {});\n    let babelPlugins = (babelOptions.plugins = babelOptions.plugins || []);\n    if (!babelPlugins.some(isAnalyzerPlugin)) {\n      // the MARKER is included so that babel caches will invalidate if the\n      // MARKER changes\n      babelPlugins.unshift([require.resolve('./analyzer-plugin'), { MARKER }]);\n    }\n  }\n\n  // We need to disable fingerprinting of chunks, because (1) they already\n  // have their own webpack-generated hashes and (2) the runtime loader code\n  // can't easily be told about broccoli-asset-rev's hashes.\n  private configureFingerprints(host: AppInstance) {\n    let patterns = ['assets/chunk.*.js', 'assets/chunk.*.css'];\n    if (!host.options.fingerprint) {\n      host.options.fingerprint = {};\n    }\n    if (!('exclude' in host.options.fingerprint)) {\n      host.options.fingerprint.exclude = patterns;\n    } else {\n      for (let pattern of patterns) {\n        host.options.fingerprint.exclude.push(pattern);\n      }\n    }\n  }\n}\n\nfunction depsFor(allAppTree: Node, packages: Set<Package>) {\n  let deps = [allAppTree];\n  for (let pkg of packages) {\n    let watched = pkg.watchedDirectories;\n    if (watched) {\n      deps = deps.concat(watched.map((dir) => new WatchedDir(dir)));\n      debugWatch(`Adding watched directories: ${watched.join(', ')}`);\n    }\n  }\n  return deps;\n}\n\nfunction isAnalyzerPlugin(entry: unknown) {\n  const suffix = path.join('ember-auto-import', 'js', 'analyzer-plugin.js');\n  return (\n    (typeof entry === 'string' && entry.endsWith(suffix)) ||\n    (Array.isArray(entry) &&\n      typeof entry[0] === 'string' &&\n      entry[0].endsWith(suffix))\n  );\n}\n"]}