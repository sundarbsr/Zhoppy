{"version":3,"file":"watch-utils.js","sourceRoot":"","sources":["../ts/watch-utils.ts"],"names":[],"mappings":";;;;;AAaA,8DAkBC;AAMD,oDAiBC;AAMD,sDAQC;AApED,0DAAiC;AACjC,+BAA+B;AAC/B,uDAA6D;AAQ7D;;GAEG;AACH,SAAgB,yBAAyB,CAAC,IAAc;IACtD,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,SAAS,EAAE,EAAE;QACxC,IAAI,GAAG,GAAG,IAAA,cAAO,EAAC,SAAS,CAAC,CAAC;QAE7B,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACzB,OAAO,CAAC,GAAG,CAAC,CAAC;QACf,CAAC;QAED,IAAI,UAAU,GAAG,OAAO,CAAC,MAAM,CAC7B,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC,IAAA,mBAAQ,EAAC,GAAG,EAAE,WAAW,CAAC,CAC7C,CAAC;QAEF,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,WAAW,EAAE,EAAE,CAAC,IAAA,mBAAQ,EAAC,WAAW,EAAE,GAAG,CAAC,CAAC,EAAE,CAAC;YAClE,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACvB,CAAC;QAED,OAAO,UAAU,CAAC;IACpB,CAAC,EAAE,EAAc,CAAC,CAAC;AACrB,CAAC;AAED;;;GAGG;AACH,SAAgB,oBAAoB,CAAC,WAAmB;IACtD,MAAM,WAAW,GACf,IAAA,4CAAyB,EAAC,WAAW,CAAC,CAAC;IAEzC,OAAO,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC;SAC9B,GAAG,CACF,CAAC,YAAY,EAAE,EAAE;;QACf,OAAA,MAAA,YAAY,CAAC,IAAI,CACf,CAAC,CAAC,UAAU,CAAC,EAAE,EAAE,CACf,CAAC,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;YACjE,CAAC,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC;YAC7B,CAAC,UAAU,CAAC,QAAQ,CAAC,SAAS,CAAC;YAC/B,CAAC,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAC/B,0CAAG,CAAC,CAAC,CAAA;KAAA,CACT;SACA,MAAM,CAAC,CAAC,IAAI,EAAkB,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;SACxC,MAAM,CAAC,CAAC,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,KAAK,CAAC,CAAC;AACnE,CAAC;AAED;;;GAGG;AACH,SAAgB,qBAAqB,CAAC,WAAmB;IACvD,MAAM,OAAO,GAAG,oBAAoB,CAAC,WAAW,CAAC,CAAC,MAAM,CACtD,CAAC,MAAM,EAAE,EAAE;IACT,sIAAsI;IACtI,6FAA6F;IAC7F,CAAC,MAAM,CAAC,KAAK,CAAC,oBAAoB,CAAC,CACtC,CAAC;IACF,OAAO,yBAAyB,CAAC,OAAO,CAAC,CAAC;AAC5C,CAAC","sourcesContent":["import isSubdir from 'is-subdir';\nimport { dirname } from 'path';\nimport { getPackageEntryPointsSync } from 'pkg-entry-points';\n\n// copied from pkg-entry-points, as we cannot use their types, see comment above\ntype ConditionToPath = [conditions: string[], internalPath: string];\ntype PackageEntryPoints = {\n  [subpath: string]: ConditionToPath[];\n};\n\n/**\n * Given a list of files, it will return the smallest set of directories that contain all these files\n */\nexport function commonAncestorDirectories(dirs: string[]): string[] {\n  return dirs.reduce((results, fileOrDir) => {\n    let dir = dirname(fileOrDir);\n\n    if (results.length === 0) {\n      return [dir];\n    }\n\n    let newResults = results.filter(\n      (existingDir) => !isSubdir(dir, existingDir)\n    );\n\n    if (!newResults.some((existingDir) => isSubdir(existingDir, dir))) {\n      newResults.push(dir);\n    }\n\n    return newResults;\n  }, [] as string[]);\n}\n\n/**\n * Given a path to a package, it will return all its internal(!) module files that are importable,\n * taking into account explicit package.json exports, filtered down to only include importable runtime code\n */\nexport function getImportableModules(packagePath: string): string[] {\n  const entryPoints: PackageEntryPoints =\n    getPackageEntryPointsSync(packagePath);\n\n  return Object.values(entryPoints)\n    .map(\n      (alternatives) =>\n        alternatives.find(\n          ([conditions]) =>\n            (conditions.includes('import') || conditions.includes('default')) &&\n            !conditions.includes('types') &&\n            !conditions.includes('require') &&\n            !conditions.includes('node')\n        )?.[1]\n    )\n    .filter((item): item is string => !!item)\n    .filter((item, index, array) => array.indexOf(item) === index);\n}\n\n/**\n * Given a package path, it will return the list smallest set of directories that contain importable code.\n * This can be used to constrain the set of directories used for file watching, to not include the whole package directory.\n */\nexport function getWatchedDirectories(packagePath: string): string[] {\n  const modules = getImportableModules(packagePath).filter(\n    (module) =>\n      // this is a workaround for excluding the addon-main.cjs module commonly used in v2 addons, which is _not_ importable in runtime code,\n      // but the generic logic based on (conditional) exports does not exclude that out of the box.\n      !module.match(/\\/addon-main.c?js$/)\n  );\n  return commonAncestorDirectories(modules);\n}\n"]}