{"version":3,"file":"get-config.js","sourceRoot":"","sources":["get-config.ts"],"names":[],"mappings":"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","sourcesContent":["import type { NodePath } from '@babel/traverse';\nimport type State from './state';\nimport type { RewrittenPackageCache, Package } from '@embroider/shared-internals';\nimport error from './error';\nimport type { ConfidentResult } from './evaluate-json';\nimport { Evaluator, assertArray, buildLiterals } from './evaluate-json';\nimport assertNever from 'assert-never';\nimport type * as Babel from '@babel/core';\nimport type { types as t } from '@babel/core';\n\nexport type Mode = 'own' | 'getGlobalConfig' | 'package';\n\nfunction getPackage(path: NodePath<t.CallExpression>, state: State, mode: 'own' | 'package'): { root: string } | null {\n  let packageName: string | undefined;\n  if (mode === 'own') {\n    if (path.node.arguments.length !== 0) {\n      throw error(path, `getOwnConfig takes zero arguments, you passed ${path.node.arguments.length}`);\n    }\n    packageName = undefined;\n  } else if (mode === 'package') {\n    if (path.node.arguments.length !== 1) {\n      throw error(path, `getConfig takes exactly one argument, you passed ${path.node.arguments.length}`);\n    }\n    let packageNode = path.node.arguments[0];\n    if (packageNode.type !== 'StringLiteral') {\n      throw error(assertArray(path.get('arguments'))[0], `the argument to getConfig must be a string literal`);\n    }\n    packageName = packageNode.value;\n  } else {\n    assertNever(mode);\n  }\n  return targetPackage(state.originalOwningPackage(), packageName, state.packageCache);\n}\n\n// this evaluates to the actual value of the config. It can be used directly by the Evaluator.\nexport default function getConfig(path: NodePath<t.CallExpression>, state: State, mode: Mode) {\n  let config: unknown | undefined;\n  if (mode === 'getGlobalConfig') {\n    return state.opts.globalConfig;\n  }\n  let pkg = getPackage(path, state, mode);\n  if (pkg) {\n    config = state.opts.userConfigs[pkg.root];\n  }\n  return config;\n}\n\n// this is the imperative version that's invoked directly by the babel visitor\n// when we encounter getConfig. It's implemented in terms of getConfig so we can\n// be sure we have the same semantics.\nexport function insertConfig(path: NodePath<t.CallExpression>, state: State, mode: Mode, context: typeof Babel) {\n  if (state.opts.mode === 'compile-time') {\n    let config = getConfig(path, state, mode);\n    let collapsed = collapse(path, config);\n    let literalResult = buildLiterals(collapsed.config, context);\n    collapsed.path.replaceWith(literalResult);\n  } else {\n    if (mode === 'getGlobalConfig') {\n      let callee = path.get('callee');\n      callee.replaceWith(state.importUtil.import(callee, state.pathToOurAddon('runtime'), 'getGlobalConfig'));\n    } else {\n      let pkg = getPackage(path, state, mode);\n      let pkgRoot;\n      if (pkg) {\n        pkgRoot = context.types.stringLiteral(pkg.root);\n      } else {\n        pkgRoot = context.types.identifier('undefined');\n      }\n      path.replaceWith(\n        context.types.callExpression(state.importUtil.import(path, state.pathToOurAddon('runtime'), 'config'), [\n          pkgRoot,\n        ])\n      );\n    }\n  }\n}\n\nfunction targetPackage(\n  us: Package,\n  packageName: string | undefined,\n  packageCache: RewrittenPackageCache\n): Package | null {\n  if (!packageName) {\n    return us;\n  }\n  try {\n    let target = packageCache.resolve(packageName, us);\n    return packageCache.original(target);\n  } catch (err) {\n    return null;\n  }\n}\n\nfunction collapse(path: NodePath, config: unknown) {\n  let evaluator = new Evaluator({\n    knownPaths: new Map([[path, { confident: true, value: config, hasRuntimeImplementation: false }]]),\n  });\n\n  while (true) {\n    let parentPath = path.parentPath!;\n    let result = evaluator.evaluate(parentPath);\n    if (!result.confident || parentPath.isAssignmentExpression()) {\n      return { path, config: (evaluator.evaluate(path) as ConfidentResult).value };\n    }\n    path = parentPath;\n  }\n}\n\nexport function inlineRuntimeConfig(path: NodePath<t.FunctionDeclaration>, state: State, context: typeof Babel) {\n  path.get('body').node.body = [\n    context.types.returnStatement(\n      buildLiterals({ packages: state.opts.userConfigs, global: state.opts.globalConfig }, context)\n    ),\n  ];\n}\n"]}